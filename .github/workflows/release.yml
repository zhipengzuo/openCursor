name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v0.1.0
  release:
    types: [created, published]  # åœ¨GitHubç•Œé¢åˆ›å»ºæˆ–å‘å¸ƒreleaseæ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GO_VERSION: '1.21'

jobs:
  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # macOS Intel
          - os: darwin
            arch: amd64
            runner: macos-latest
            binary_name: openCursor-darwin-amd64
          # macOS Apple Silicon
          - os: darwin
            arch: arm64
            runner: macos-latest
            binary_name: openCursor-darwin-arm64
          # Linux x86_64
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            binary_name: openCursor-linux-amd64
          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            binary_name: openCursor-linux-arm64
          # Windows (å¯é€‰)
          - os: windows
            arch: amd64
            runner: windows-latest
            binary_name: openCursor-windows-amd64.exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Get dependencies
      run: go mod download

    - name: Build binary
      env:
        GOOS: ${{ matrix.os }}
        GOARCH: ${{ matrix.arch }}
        CGO_ENABLED: 0
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "Building version: $VERSION"
        go build -ldflags="-s -w -X main.Version=$VERSION" -o ${{ matrix.binary_name }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}
        path: ${{ matrix.binary_name }}
        retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Prepare release assets
      run: |
        mkdir -p ./release-assets
        # ç§»åŠ¨æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶åˆ°release-assetsç›®å½•
        find ./artifacts -name "openCursor-*" -type f -exec cp {} ./release-assets/ \;
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        cd ./release-assets
        sha256sum * > checksums.txt
        ls -la

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref_name }}
        name: Release ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref_name }}
        body: |
          ## ğŸš€ openCursor ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **macOS ç”¨æˆ·ï¼š**
          - Intel èŠ¯ç‰‡: `openCursor-darwin-amd64`
          - Apple Silicon (M1/M2/M3): `openCursor-darwin-arm64`
          
          **Linux ç”¨æˆ·ï¼š**
          - x86_64: `openCursor-linux-amd64`
          - ARM64: `openCursor-linux-arm64`
          
          **Windows ç”¨æˆ·ï¼š**
          - x86_64: `openCursor-windows-amd64.exe`
          
          ### ğŸ“‹ å®‰è£…æ–¹æ³•
          
          **macOS/Linux:**
          ```bash
          # ä¸‹è½½å¯¹åº”ä½ ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.event_name == 'release' && github.event.release.tag_name || github.ref_name }}/openCursor-darwin-amd64
          
          # é‡å‘½åå¹¶æ·»åŠ æ‰§è¡Œæƒé™
          mv openCursor-darwin-amd64 openCursor
          chmod +x openCursor
          
          # ç§»åŠ¨åˆ°PATHç›®å½•
          sudo mv openCursor /usr/local/bin/
          ```
          
          **Windows:**
          ```powershell
          # ä¸‹è½½ openCursor-windows-amd64.exe
          # é‡å‘½åä¸º openCursor.exe å¹¶æ”¾åˆ° PATH ç›®å½•
          ```
          
          ### âœ… æ–‡ä»¶æ ¡éªŒ
          
          ä½¿ç”¨ `checksums.txt` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ### ğŸ”§ é…ç½®å’Œä½¿ç”¨
          
          ```bash
          # è®¾ç½®APIå¯†é’¥
          export OPENAI_API_KEY="your-deepseek-api-key"
          
          # æŸ¥çœ‹ç‰ˆæœ¬
          openCursor version
          
          # å¼€å§‹ä½¿ç”¨
          openCursor "Hello, how are you?"
          ```
          
          ### ğŸ› ï¸ ç¯å¢ƒå˜é‡
          
          - `OPENAI_API_KEY`: DeepSeek APIå¯†é’¥ (å¿…éœ€)
          - `MODEL`: æ¨¡å‹åç§° (é»˜è®¤: deepseek-chat)
          - `BASE_URL`: APIåŸºç¡€URL (é»˜è®¤: https://api.deepseek.com/v1)
          
          ---
          
          å¦‚æœ‰é—®é¢˜è¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false
        files: |
          ./release-assets/*
        token: ${{ secrets.GITHUB_TOKEN }} 